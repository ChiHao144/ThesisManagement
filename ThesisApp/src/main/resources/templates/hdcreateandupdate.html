<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>Thành lập hội đồng</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
        <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
              rel="stylesheet"/>
        <style>
            .dual-list-box {
                display: flex;
                gap: 1rem;
            }

            .list-box {
                width: 45%;
            }

            .list-box select {
                height: 200px;
            }

            .btn-move {
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div th:replace="base :: header"></div>
        <div class="container mt-4">
            <h3 class="text-center mb-4">Thành lập hội đồng</h3>

            <form th:action="@{/save}" method="post">
                <div th:if="${errorMessage}" class="alert alert-danger">
                    <p th:text="${errorMessage}"></p>
                </div>
                <input type="hidden" name="id" th:value="${hoiDong.id}" />
                <!-- Ngày bảo vệ -->
                <div class="mb-3">
                    <label for="ngayBaoVe" class="form-label">Ngày bảo vệ</label>
                    <input type="date" class="form-control" id="ngayBaoVe" name="ngayBaoVe"
                           th:value="${#dates.format(hoiDong.ngayBaoVe, 'yyyy-MM-dd')}" required>
                </div>

               
                <div class="mb-3">
                    <label for="noiDungBaoVe" class="form-label">Nơi bảo vệ</label>
                    <input type="text" class="form-control" id="noiDungBaoVe" name="noiDungBaoVe"
                           th:value="${hoiDong.noiDungBaoVe}" required>
                </div>

                
                <h5>Thành viên hội đồng</h5>
                <div id="members-container">
                    <div th:each="idx, stat : ${#numbers.sequence(0, selectedGiangVienIds != null ? selectedGiangVienIds.size() - 1 : 0)}"
                         class="row mb-2 member-row">

                        <div class="col-md-6">
                            <select class="form-select js-giangvien-select" name="giangVienIds" required>
                                <option value="">-- Chọn giảng viên --</option>
                                <option th:each="gv : ${giangViens}"
                                        th:value="${gv.id}"
                                        th:text="${gv.user.fullname}"
                                        th:selected="${gv.id == selectedGiangVienIds[__${idx}__]}">
                                </option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <select class="form-select" name="vaiTros" required>
                                <option value="chu_tich" th:selected="${selectedVaiTros[__${idx}__] == 'chu_tich'}">Chủ tịch</option>
                                <option value="thu_ky" th:selected="${selectedVaiTros[__${idx}__] == 'thu_ky'}">Thư ký</option>
                                <option value="uy_vien" th:selected="${selectedVaiTros[__${idx}__] == 'uy_vien'}">Ủy viên</option>
                                <option value="phan_bien" th:selected="${selectedVaiTros[__${idx}__] == 'phan_bien'}">Phản biện</option>
                                <option value="thanh_vien" th:selected="${selectedVaiTros[__${idx}__] == 'thanh_vien'}">Thành viên</option>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-center">
                            <button type="button" th:if="${stat.index == 0}" class="btn btn-success" onclick="addMemberRow()">+</button>
                            <button type="button" th:if="${stat.index > 0}" class="btn btn-danger" onclick="removeMemberRow(this)">-</button>
                        </div>
                    </div>
                </div>

               
                <h5 class="mt-4">Danh sách khoá luận</h5>
                <div class="dual-list-box">
                    
                    <div class="list-box">
                        <input type="text" class="form-control mb-2" placeholder="Tìm khoá luận..."
                               onkeyup="filterList(this, 'listAvailable')">
                        <select id="listAvailable" multiple>
                            
                            <option th:each="kl : ${khoaluans}"
                                    th:if="${selectedKhoaLuanIds == null or !selectedKhoaLuanIds.contains(kl.id)}"
                                    th:value="${kl.id}"
                                    th:text="${kl.chuDe}"></option>
                        </select>
                    </div>

                    
                    <div class="btn-move">
                        <button type="button" class="btn btn-primary" onclick="moveSelected('listAvailable', 'listSelected')">→</button>
                        <button type="button" class="btn btn-secondary" onclick="moveSelected('listSelected', 'listAvailable')">←</button>
                    </div>

                   
                    <div class="list-box">
                        <input type="text" class="form-control mb-2" placeholder="Tìm khoá luận..."
                               onkeyup="filterList(this, 'listSelected')">
                        <select id="listSelected" name="khoaLuanIds" multiple>
                            
                            <option th:each="kl : ${khoaluans}"
                                    th:if="${selectedKhoaLuanIds != null and selectedKhoaLuanIds.contains(kl.id)}"
                                    th:value="${kl.id}"
                                    th:text="${kl.chuDe}"
                                    selected> 
                            </option>
                        </select>
                    </div>
                </div>

                
                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-success">
                        <span th:if="${hoiDong.id == null}">Thành lập hội đồng</span>
                        <span th:if="${hoiDong.id != null}">Cập nhật hội đồng</span>
                    </button>
                    <a th:href="@{/hoidongs}" class="btn btn-secondary">Hủy</a>
                </div>
            </form>
        </div>

        <div th:replace="base :: footer"></div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

        <script>
                                   
                                   function addMemberRow() {
                                       const container = $('#members-container');
                                       const firstRow = container.find('.member-row').first();
                                       const newRow = firstRow.clone();

                                       newRow.find('.select2-container').remove(); 
                                       newRow.find('select').val(''); 

                                       const newButton = newRow.find('button');
                                       newButton.removeClass('btn-success').addClass('btn-danger').text('-');
                                       newButton.attr('onclick', 'removeMemberRow(this)');

                                       container.append(newRow);

                                       
                                       newRow.find('.js-giangvien-select').select2({
                                           placeholder: 'Nhập mã hoặc tên giảng viên...',
                                           allowClear: true,
                                           width: '100%',
                                           theme: 'bootstrap-5'
                                       });
                                   }

                                   function removeMemberRow(btn) {
                                       $(btn).closest('.member-row').remove();
                                   }

                                   
                                   function moveSelected(fromId, toId) {
                                       const from = document.getElementById(fromId);
                                       const to = document.getElementById(toId);
                                       Array.from(from.selectedOptions).forEach(option => {
                                           to.appendChild(option);
                                           
                                           option.selected = (toId === 'listSelected');
                                       });
                                   }

                                   function filterList(input, listId) {
                                       const filter = input.value.toLowerCase();
                                       const options = document.getElementById(listId).options;
                                       for (let option of options) {
                                           option.style.display = option.text.toLowerCase().includes(filter) ? '' : 'none';
                                       }
                                   }

                                   $(document).ready(function () {
                                      
                                       $('.js-giangvien-select').select2({
                                           placeholder: 'Nhập mã hoặc tên giảng viên...',
                                           allowClear: true,
                                           width: '100%',
                                           theme: 'bootstrap-5'
                                       });
                                   });
        </script>
    </body>
</html>
